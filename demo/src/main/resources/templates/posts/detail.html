<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title th:text="${post.title}">게시글</title>
</head>

<body th:data-post-id="${post.id}">

<h2 th:text="${post.title}"></h2>

<p>
    작성자:
    <span th:text="${post.user.username}"></span> |
    작성일:
    <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
</p>

<hr>

<div th:text="${post.content}"></div>

<hr>

<!-- 게시글 수정 / 삭제 -->
<div th:if="${loginUser != null}">
    <th:block th:if="${loginUser.username == post.user.username}">
        <a th:href="@{|/posts/${post.id}/edit|}">수정</a>

        <form th:action="@{|/posts/${post.id}/delete|}"
              method="post"
              style="display:inline"
              onsubmit="return confirm('정말 삭제하시겠습니까?')">
            <button type="submit">삭제</button>
        </form>
    </th:block>
</div>

<hr>

<h3>댓글</h3>

<!-- 댓글 목록 -->
<div id="comment-list"></div>

<!-- 댓글 작성 -->
<div th:if="${loginUser != null}">
    <form id="comment-form">
        <textarea id="comment-content" required></textarea>
        <br>
        <button type="submit">댓글 작성</button>
    </form>
</div>

<div th:if="${loginUser == null}">
    <p>댓글을 작성하려면 로그인하세요.</p>
</div>

<a th:href="@{/posts}">목록</a>

<!-- ================= JS ================= -->
<script>
const postId = document.body.dataset.postId;

/* 댓글 목록 */
function loadComments() {
    fetch(`/api/posts/${postId}/comments`)
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById("comment-list");
            list.innerHTML = "";

            data.forEach(comment => {
                const div = document.createElement("div");

                let actionBtns = "";
                if (comment.mine) {
                    actionBtns = `
                        <button class="edit-btn"
                                data-id="${comment.id}"
                                data-content="${comment.content}">
                            수정
                        </button>
                        <button onclick="deleteComment(${comment.id})">삭제</button>
                    `;
                }

                div.innerHTML = `
                    <p>
                        <b>${comment.username}</b> :
                        <span>${comment.content}</span>
                        <small>(${comment.createdAt})</small>
                        ${actionBtns}
                    </p>
                `;

                list.appendChild(div);
            });
        });
}

/* 댓글 작성 */
document.getElementById("comment-form")?.addEventListener("submit", e => {
    e.preventDefault();

    const content = document.getElementById("comment-content").value;

    fetch(`/api/posts/${postId}/comments`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content })
    }).then(res => {
        if (res.ok) {
            document.getElementById("comment-content").value = "";
            loadComments();
        }
    });
});

/* 댓글 삭제 */
function deleteComment(id) {
    fetch(`/api/comments/${id}`, { method: "DELETE" })
        .then(res => {
            if (res.ok) loadComments();
            else alert("삭제 권한 없음");
        });
}

/* 댓글 수정 (이벤트 위임) */
document.addEventListener("click", e => {
    if (e.target.classList.contains("edit-btn")) {
        const id = e.target.dataset.id;
        const oldContent = e.target.dataset.content;

        const newContent = prompt("댓글 수정", oldContent);
        if (!newContent) return;

        fetch(`/api/comments/${id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content: newContent })
        }).then(res => {
            if (res.ok) loadComments();
            else alert("수정 권한 없음");
        });
    }
});

loadComments();
</script>

</body>
</html>
